<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Image Crop & Banner Editor</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">

  <style>
    :root {
      --primary: #4a6bff;
      --primary-dark: #3a5ae0;
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --text: #e0e0ff;
      --text-secondary: #a0a0d0;
      --border: #2a2a4a;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    h1 {
      font-size: 1.8rem;
      font-weight: 600;
      text-align: center;
      background: linear-gradient(90deg, #a78bfa, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 1.5rem;
      max-width: 1800px;
      margin: 0 auto;
      width: 100%;
    }

    .editor-layout {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1.5rem;
      flex: 1;
    }

    .canvas-container {
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    #canvas-wrapper {
      position: relative;
      flex: 1;
      background: #000;
      overflow: auto;
    }

    #main-canvas {
      image-rendering: pixelated;
      touch-action: none;
    }

    .toolbar {
      padding: 1rem;
      background: var(--surface);
      border-top: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      justify-content: center;
    }

    .btn {
      padding: 0.7rem 1.3rem;
      border: none;
      border-radius: 8px;
      background: var(--primary);
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    .btn.secondary {
      background: #6b7280;
    }

    .btn.danger {
      background: #ef4444;
    }

    .controls {
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 1.2rem;
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    input[type="range"],
    input[type="number"],
    select {
      width: 100%;
      padding: 0.5rem;
      background: #242444;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
    }

    input[type="color"] {
      width: 100%;
      height: 42px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .banner-text {
      position: absolute;
      color: white;
      font-size: 3rem;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(0,0,0,0.8);
      pointer-events: auto;
      user-select: text;
      cursor: text;
      white-space: pre;
      background: rgba(0,0,0,0.4);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      border: 2px dashed #ffffff66;
      min-width: 200px;
      text-align: center;
    }

    .banner-text:focus {
      outline: 2px solid var(--primary);
      background: rgba(0,0,0,0.6);
    }

    @media (max-width: 900px) {
      .editor-layout {
        grid-template-columns: 1fr;
      }
      
      .controls {
        order: -1;
      }
    }
  </style>
</head>
<body>

  <header>
    <h1>Image Crop & Banner Editor</h1>
  </header>

  <div class="container">
    <div class="editor-layout">
      <!-- Main canvas area -->
      <div class="canvas-container">
        <div id="canvas-wrapper">
          <canvas id="main-canvas"></canvas>
        </div>
        
        <div class="toolbar">
          <button class="btn" id="uploadBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="17 8 12 3 7 8"/>
              <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            Upload Image
          </button>

          <input type="file" id="imageInput" accept="image/*" hidden>

          <button class="btn secondary" id="resetBtn">Reset</button>
          <button class="btn" id="downloadBtn">Download</button>
        </div>
      </div>

      <!-- Controls sidebar -->
      <div class="controls">
        <div class="control-group">
          <label>Text Content</label>
          <input type="text" id="bannerText" value="Your text here" placeholder="Enter banner text">
        </div>

        <div class="control-group">
          <label>Text Size</label>
          <input type="range" id="textSize" min="20" max="200" value="60">
          <input type="number" id="textSizeNum" min="20" max="200" value="60">
        </div>

        <div class="control-group">
          <label>Text Color</label>
          <input type="color" id="textColor" value="#ffffff">
        </div>

        <div class="control-group">
          <label>Font Family</label>
          <select id="fontFamily">
            <option value="Arial">Arial</option>
            <option value="Helvetica">Helvetica</option>
            <option value="Impact">Impact</option>
            <option value="Georgia">Georgia</option>
            <option value="Courier New">Courier New</option>
            <option value="Times New Roman">Times New Roman</option>
          </select>
        </div>

        <div class="control-group">
          <label>Text Position X</label>
          <input type="range" id="textX" min="0" max="100" value="50">
          <input type="number" id="textXNum" min="0" max="100" value="50"> %
        </div>

        <div class="control-group">
          <label>Text Position Y</label>
          <input type="range" id="textY" min="0" max="100" value="50">
          <input type="number" id="textYNum" min="0" max="100" value="50"> %
        </div>

        <div class="control-group">
          <label>Text Shadow</label>
          <input type="range" id="shadowBlur" min="0" max="30" value="10">
        </div>
      </div>
    </div>
  </div>

  <script>
    // ───────────────────────────────────────────────
    //  Core Variables
    // ───────────────────────────────────────────────
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    let img = new Image();
    let bannerTextElement = null;
    let currentText = "Your text here";

    // ───────────────────────────────────────────────
    //  Canvas Setup & Resize
    // ───────────────────────────────────────────────
    function resizeCanvas() {
      const container = document.getElementById('canvas-wrapper');
      const dpr = window.devicePixelRatio || 1;
      
      canvas.width = container.clientWidth * dpr;
      canvas.height = container.clientHeight * dpr;
      canvas.style.width = container.clientWidth + 'px';
      canvas.style.height = container.clientHeight + 'px';
      
      ctx.scale(dpr, dpr);
      redraw();
    }

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // ───────────────────────────────────────────────
    //  Upload Image
    // ───────────────────────────────────────────────
    document.getElementById('uploadBtn').addEventListener('click', () => {
      document.getElementById('imageInput').click();
    });

    document.getElementById('imageInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        img.onload = () => {
          redraw();
          updateTextPosition();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // ───────────────────────────────────────────────
    //  Redraw Canvas + Text Overlay
    // ───────────────────────────────────────────────
    function redraw() {
      ctx.fillStyle = '#000';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      if (img.src) {
        const ratio = Math.min(
          canvas.width / img.width,
          canvas.height / img.height
        );
        
        const w = img.width * ratio;
        const h = img.height * ratio;
        const x = (canvas.width - w) / 2;
        const y = (canvas.height - h) / 2;

        ctx.drawImage(img, x, y, w, h);
      }
    }

    // ───────────────────────────────────────────────
    //  Banner Text Management
    // ───────────────────────────────────────────────
    function createTextOverlay() {
      if (bannerTextElement) {
        bannerTextElement.remove();
      }

      bannerTextElement = document.createElement('div');
      bannerTextElement.className = 'banner-text';
      bannerTextElement.id = 'banner-text-el';
      bannerTextElement.textContent = currentText;
      bannerTextElement.contentEditable = true;

      document.getElementById('canvas-wrapper').appendChild(bannerTextElement);
      updateTextStyle();
      updateTextPosition();
      
      // Focus when clicking text
      bannerTextElement.addEventListener('click', () => {
        bannerTextElement.focus();
      });

      // Update on input
      bannerTextElement.addEventListener('input', () => {
        currentText = bannerTextElement.textContent;
        document.getElementById('bannerText').value = currentText;
      });
    }

    function updateTextStyle() {
      if (!bannerTextElement) return;

      const size = document.getElementById('textSize').value;
      const color = document.getElementById('textColor').value;
      const font = document.getElementById('fontFamily').value;
      const shadow = document.getElementById('shadowBlur').value;

      bannerTextElement.style.fontSize = size + 'px';
      bannerTextElement.style.color = color;
      bannerTextElement.style.fontFamily = font;
      bannerTextElement.style.textShadow = `0 0 ${shadow}px rgba(0,0,0,0.9)`;
    }

    function updateTextPosition() {
      if (!bannerTextElement) return;

      const xPercent = document.getElementById('textX').value;
      const yPercent = document.getElementById('textY').value;

      const x = (canvas.offsetWidth * xPercent / 100) - (bannerTextElement.offsetWidth / 2);
      const y = (canvas.offsetHeight * yPercent / 100) - (bannerTextElement.offsetHeight / 2);

      bannerTextElement.style.left = x + 'px';
      bannerTextElement.style.top = y + 'px';
    }

    // ───────────────────────────────────────────────
    //  Controls Listeners
    // ───────────────────────────────────────────────
    document.getElementById('bannerText').addEventListener('input', (e) => {
      currentText = e.target.value;
      if (bannerTextElement) {
        bannerTextElement.textContent = currentText;
        updateTextPosition();
      }
    });

    const inputs = ['textSize', 'textColor', 'fontFamily', 'shadowBlur', 'textX', 'textY'];
    inputs.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener('input', () => {
          updateTextStyle();
          updateTextPosition();
          if (id === 'textSize' || id === 'textX' || id === 'textY') {
            const numEl = document.getElementById(id + 'Num');
            if (numEl) numEl.value = el.value;
          }
        });
      }
    });

    // Sync range ↔ number inputs
    ['textSize', 'textX', 'textY'].forEach(base => {
      const range = document.getElementById(base);
      const num = document.getElementById(base + 'Num');
      if (range && num) {
        range.addEventListener('input', () => num.value = range.value);
        num.addEventListener('input', () => {
          if (num.value !== '') range.value = num.value;
        });
      }
    });

    // ───────────────────────────────────────────────
    //  Reset & Download
    // ───────────────────────────────────────────────
    document.getElementById('resetBtn').addEventListener('click', () => {
      img.src = '';
      redraw();
      if (bannerTextElement) bannerTextElement.remove();
      bannerTextElement = null;
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      // Create temporary canvas with only image + text
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;

      // Draw background image
      if (img.src) {
        const ratio = Math.min(
          tempCanvas.width / img.width,
          tempCanvas.height / img.height
        );
        const w = img.width * ratio;
        const h = img.height * ratio;
        const x = (tempCanvas.width - w) / 2;
        const y = (tempCanvas.height - h) / 2;
        tempCtx.drawImage(img, x, y, w, h);
      }

      // Draw text
      if (bannerTextElement) {
        const size = parseInt(bannerTextElement.style.fontSize);
        const color = bannerTextElement.style.color;
        const font = bannerTextElement.style.fontFamily;
        const shadow = bannerTextElement.style.textShadow.match(/\d+/)?.[0] || 10;

        tempCtx.font = `${size}px ${font}`;
        tempCtx.fillStyle = color;
        tempCtx.shadowColor = 'black';
        tempCtx.shadowBlur = shadow;
        tempCtx.textAlign = 'center';
        tempCtx.textBaseline = 'middle';

        const x = tempCanvas.width / 2;
        const y = tempCanvas.height / 2;

        tempCtx.fillText(currentText, x, y);
      }

      // Download
      const link = document.createElement('a');
      link.download = 'edited-image.png';
      link.href = tempCanvas.toDataURL('image/png');
      link.click();
    });

    // ───────────────────────────────────────────────
    //  Initialize
    // ───────────────────────────────────────────────
    createTextOverlay();

    // Make sure text is created on first load
    setTimeout(() => {
      if (!bannerTextElement) createTextOverlay();
    }, 500);
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('Service Worker registered successfully', reg.scope))
          .catch(err => console.error('Service Worker registration failed:', err));
      });
    }
  </script>
</body>
</html>